<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Custom Dataset Chatbot</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif; margin: 0; background: #0b1020; color: #e8ecf1; }
      .container { max-width: 860px; margin: 0 auto; padding: 24px; }
      h1 { font-size: 20px; font-weight: 600; display: flex; gap: 8px; align-items: center; }
      .chat { background: #101632; border: 1px solid #1c2448; border-radius: 12px; overflow: hidden; }
      .messages { height: 60vh; overflow-y: auto; padding: 16px; }
      .msg { padding: 10px 12px; border-radius: 10px; margin-bottom: 8px; max-width: 80%; white-space: pre-wrap; }
      .user { background: #1f2a52; margin-left: auto; }
      .bot { background: #141b3b; }
      .input { display: flex; gap: 8px; padding: 12px; border-top: 1px solid #1c2448; background: #0e1430; }
      input[type="text"] { flex: 1; padding: 12px 14px; border-radius: 8px; border: 1px solid #1c2448; background: #0b1026; color: #e8ecf1; }
      button { padding: 12px 14px; border-radius: 8px; background: #4c6fff; color: white; border: 0; cursor: pointer; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      .source { color: #9fb0ff; font-size: 12px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Custom Dataset Chatbot</h1>
      <div class="chat">
        <div id="messages" class="messages"></div>
        <div class="input">
          <input id="input" type="text" placeholder="Ask about your data..." />
          <button id="send">Send</button>
        </div>
      </div>
    </div>
    <script>
      const messagesEl = document.getElementById('messages');
      const inputEl = document.getElementById('input');
      const sendBtn = document.getElementById('send');

      const messages = [];

      function render() {
        messagesEl.innerHTML = messages.map(m => `<div class="msg ${m.role === 'user' ? 'user' : 'bot'}">${m.content}</div>`).join('');
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      async function send() {
        const text = inputEl.value.trim();
        if (!text) return;
        inputEl.value = '';
        messages.push({ role: 'user', content: text });
        messages.push({ role: 'assistant', content: '' });
        render();

        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages, top_k: 5 }),
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          messages[messages.length - 1].content = 'Error: ' + (err.detail || res.statusText);
          render();
          return;
        }
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          // naive SSE parse
          for (const line of chunk.split('\n')) {
            if (line.startsWith('data: ')) {
              const payload = line.slice(6);
              if (payload === '') continue;
              try {
                const evt = JSON.parse(payload);
                if (evt.event === 'token') {
                  messages[messages.length - 1].content += evt.data;
                  render();
                }
              } catch { /* ignore */ }
            }
          }
        }
      }

      sendBtn.addEventListener('click', send);
      inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') send(); });
      render();
    </script>
  </body>
</html>
